generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

// generator erd {
//   provider = "prisma-erd-generator"
//   output   = "erd/erd.svg"
// }

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model UserRoleModel {
  id          Int     @id @default(autoincrement())
  nombre      String  @unique
  permisos    Json?   @default("{}")
  descripcion String?
  users       User[]

  @@map("roles")
}

model Company {
  id                  String   @id @default(uuid())
  razonSocial         String   @map("razon_social")
  rutEmpresa          String   @unique @map("rut_empresa")
  centroCosto         String?  @map("centro_costo")
  contactoComercial   String?  @map("contacto_comercial")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  serviceRequests     ServiceRequest[]
  users               User[]

  @@map("empresas_cliente")
}

model Vehicle {
  id                  String        @id @default(uuid())
  patente             String        @unique @map("patente")
  marca               String        @map("marca")
  modelo              String        @map("modelo")
  capacidadPax        Int           @map("capacidad_pax")
  estado              VehicleStatus @default(DISPONIBLE) @map("estado")
  vencimientoRevTec   DateTime?     @map("vencimiento_rev_tec")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")
  trips               Trip[]

  @@map("vehiculos")
}

model User {
  id              String           @id @default(uuid())
  rut             String           @unique
  email           String           @unique
  password        String           @map("password_hash")
  nombreCompleto  String           @map("nombre_completo")
  activo          Boolean          @default(true) @map("activo")
  rolId           Int              @map("rol_id")
  empresaId       String?          @map("empresa_id")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  role            UserRoleModel   @relation(fields: [rolId], references: [id])
  company         Company?         @relation(fields: [empresaId], references: [id])
  tripsAsDriver   Trip[]           @relation("DriverTrips")

  @@map("usuarios")
}

model ServiceRequest {
  id             String   @id @default(uuid())
  empresaId      String   @map("empresa_id")
  fechaHoraRequerida DateTime @map("fecha_hora_requerida")
  origenDireccion String @map("origen_direccion")
  destinoDireccion String @map("destino_direccion")
  cantidadPasajeros Int @map("cantidad_pasajeros")
  nominaPasajeros String? @map("nomina_pasajeros")
  estado         RequestStatus @default(PENDIENTE) @map("estado")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  company        Company  @relation(fields: [empresaId], references: [id])
  trip           Trip?

  @@map("solicitudes_servicio")
}

model Trip {
  id               String         @id @default(uuid())
  solicitudId      String         @unique @map("solicitud_id")
  choferId         String         @map("chofer_id")
  vehiculoId       String         @map("vehiculo_id")
  horaInicioReal   DateTime?      @map("hora_inicio_real")
  horaFinReal      DateTime?      @map("hora_fin_real")
  estadoActual     TripStatus     @default(EN_RUTA) @map("estado_actual")
  observaciones    String?        @map("observaciones")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  serviceRequest   ServiceRequest @relation(fields: [solicitudId], references: [id])
  driver           User           @relation("DriverTrips", fields: [choferId], references: [id])
  vehicle          Vehicle        @relation(fields: [vehiculoId], references: [id])

  @@map("viajes_asignado")
}

enum VehicleStatus {
  DISPONIBLE
  MANTENCION
  EN_RUTA
}

enum RequestStatus {
  PENDIENTE
  AGENDADO
  CANCELADO
}

enum TripStatus {
  EN_RUTA
  FINALIZADO
}

enum UserRole {
  ADMIN
  CHOFER
  CLIENTE
}
