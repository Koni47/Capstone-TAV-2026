generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

// generator erd {
//   provider = "prisma-erd-generator"
//   output   = "erd/erd.svg"
// }

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id          Int     @id @default(autoincrement())
  nombre      String  @unique
  permisos    Json?   @default("{}")
  descripcion String?
  users       User[]

  @@map("roles")
}

model User {
  id              String           @id @default(uuid())
  email           String           @unique
  password        String
  fullName        String
  name            String           @default("") // Alias para compatibilidad con endpoints
  roleId          Int              @map("role_id")
  phone           String?
  status          UserStatus       @default(ACTIVO)
  lastLogin       DateTime?        @map("lastlogin")
  createdAt       DateTime         @default(now()) @map("createdat")
  updatedAt       DateTime         @updatedAt @map("updatedat")
  companyId       String?          @map("companyid")
  role            Role             @relation(fields: [roleId], references: [id])
  serviceRequests ServiceRequest[] @relation("ClientRequests")
  tripsAsDriver   Trip[]           @relation("DriverTrips")
  company         Company?         @relation(fields: [companyId], references: [id])

  @@map("users")
}

model Company {
  id              String           @id @default(uuid())
  rut             String           @unique
  name            String
  costCenter      String?          // Hacerlo opcional
  costCenterDesc  String?          // Descripción del centro de costo
  address         String?
  contactName     String?          // Nombre del contacto principal
  contactEmail    String?
  phone           String?          // Teléfono de contacto
  contractStart   DateTime?        // Inicio de contrato
  contractEnd     DateTime?        // Fin de contrato
  status          CompanyStatus    @default(ACTIVO) // Cambiar a enum
  description     String?          // Descripción de la empresa
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  serviceRequests ServiceRequest[]
  users           User[]
  trips           Trip[]           @relation("CompanyTrips") // Relación directa con trips

  @@map("empresas_cliente")
}

model Vehicle {
  id                  String        @id @default(uuid())
  licensePlate        String        @unique
  model               String
  type                String?       // Tipo de vehículo (Van, Sedan, etc.)
  capacity            Int?          // Capacidad de pasajeros
  color               String?       // Color del vehículo
  year                Int
  mileage             Int?          // Kilometraje
  status              VehicleStatus @default(DISPONIBLE)
  technicalReviewDate DateTime?
  purchaseDate        DateTime?     // Fecha de compra
  notes               String?       // Observaciones
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  trips               Trip[]

  @@map("vehiculos")
}



model ServiceRequest {
  id             String         @id @default(uuid())
  origin         String
  destination    String
  passengerCount Int
  requestedAt    DateTime       @default(now())
  estimatedFare  Int?           // Tarifa estimada
  notes          String?
  status         RequestStatus  @default(PENDIENTE) // Cambiar a enum
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  clientId       String
  companyId      String?
  driverId       String?        // Chofer asignado directamente
  client         User           @relation("ClientRequests", fields: [clientId], references: [id])
  company        Company?       @relation(fields: [companyId], references: [id])
  trip           Trip?

  @@map("solicitudes_servicio")
}

model Trip {
  id               String          @id @default(uuid())
  title            String?         // Título del viaje
  status           TripStatus      @default(PENDIENTE)
  scheduledDate    DateTime?       // Fecha programada del viaje
  startTime        DateTime?
  endTime          DateTime?
  origin           String?         // Origen del viaje
  destination      String?         // Destino del viaje
  fare             Int?            // Tarifa del viaje
  rating           Int?
  comment          String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  serviceRequestId String?         @unique // Hacerlo opcional
  clientId         String?         // Cliente directo sin ServiceRequest
  driverId         String?
  vehicleId        String?
  driver           User?           @relation("DriverTrips", fields: [driverId], references: [id])
  serviceRequest   ServiceRequest? @relation(fields: [serviceRequestId], references: [id])
  vehicle          Vehicle?        @relation(fields: [vehicleId], references: [id])
  client           Company?        @relation("CompanyTrips", fields: [clientId], references: [id]) // Relación con Company

  @@map("trips")
}

model Complaint {
  id            String          @id @default(uuid())
  name          String          // Nombre del denunciante
  email         String          // Email del denunciante
  phone         String?         // Teléfono opcional
  type          String          // Tipo de denuncia (Servicio, Conductor, etc.)
  subject       String          // Asunto
  description   String          // Descripción detallada
  tripReference String?         // Referencia al viaje (opcional)
  status        ComplaintStatus @default(PENDIENTE) // Cambiar a enum
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@map("complaints")
}

enum UserStatus {
  ACTIVO
  INACTIVO
  PENDIENTE
}

enum CompanyStatus {
  ACTIVO
  INACTIVO
}

enum VehicleStatus {
  DISPONIBLE
  MANTENCION
  EN_RUTA
}

enum RequestStatus {
  PENDIENTE
  AGENDADO
  CANCELADO
}

enum TripStatus {
  PENDIENTE
  ASIGNADO
  EN_RUTA
  FINALIZADO
  CANCELADO
}

enum ComplaintStatus {
  PENDIENTE
  EN_REVISION
  RESUELTO
  CERRADO
}
