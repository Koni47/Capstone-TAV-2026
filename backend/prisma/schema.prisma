generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "../ERD.svg"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id @default(uuid())
  email           String           @unique
  password        String
  fullName        String
  role            Role             @default(CLIENTE)
  phone           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  companyId       String?
  status          UserStatus       @default(ACTIVO)
  serviceRequests ServiceRequest[] @relation("ClientRequests")
  tripsAsDriver   Trip[]           @relation("DriverTrips")
  company         Company?         @relation(fields: [companyId], references: [id])

  @@map("users")
}

model Company {
  id              String           @id @default(uuid())
  rut             String           @unique
  name            String
  costCenter      String
  address         String?
  contactEmail    String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  serviceRequests ServiceRequest[]
  users           User[]

  @@map("companies")
}

model Vehicle {
  id                  String        @id @default(uuid())
  licensePlate        String        @unique
  model               String
  year                Int
  status              VehicleStatus @default(DISPONIBLE)
  technicalReviewDate DateTime?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  trips               Trip[]

  @@map("vehicles")
}

model ServiceRequest {
  id             String   @id @default(uuid())
  origin         String
  destination    String
  passengerCount Int
  requestedAt    DateTime @default(now())
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  clientId       String
  companyId      String?
  client         User     @relation("ClientRequests", fields: [clientId], references: [id])
  company        Company? @relation(fields: [companyId], references: [id])
  trip           Trip?

  @@map("service_requests")
}

model Trip {
  id               String         @id @default(uuid())
  status           TripStatus     @default(PENDIENTE)
  startTime        DateTime?
  endTime          DateTime?
  rating           Int?
  comment          String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  serviceRequestId String         @unique
  driverId         String?
  vehicleId        String?
  evidenceUrl      String?
  fare             Int?
  transactions     Transaction[]
  driver           User?          @relation("DriverTrips", fields: [driverId], references: [id])
  serviceRequest   ServiceRequest @relation(fields: [serviceRequestId], references: [id])
  vehicle          Vehicle?       @relation(fields: [vehicleId], references: [id])

  @@map("trips")
}

model Transaction {
  id                 String            @id @default(uuid())
  buyOrder           String            @unique
  sessionId          String
  amount             Int
  status             TransactionStatus @default(INITIALIZED)
  token              String?           @unique
  transbankStatus    String?
  responseCode       Int?
  authorizationCode  String?
  paymentTypeCode    String?
  installmentsAmount Int?
  installmentsNumber Int?
  cardLast4Digits    String?
  accountingDate     String?
  transactionDate    DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  tripId             String
  trip               Trip              @relation(fields: [tripId], references: [id])

  @@map("transactions")
}

enum TransactionStatus {
  INITIALIZED
  AUTHORIZED
  REJECTED
  FAILED
  ERROR_COMMIT
  REFUNDED
  EXPIRED
}

enum Role {
  ADMIN
  CHOFER
  CLIENTE
}

enum UserStatus {
  ACTIVO
  INACTIVO
  SUSPENDIDO
}

enum VehicleStatus {
  DISPONIBLE
  EN_RUTA
  MANTENCION
  FUERA_DE_SERVICIO
}

enum TripStatus {
  PENDIENTE
  ASIGNADO
  EN_RUTA
  FINALIZADO
  CANCELADO
}
